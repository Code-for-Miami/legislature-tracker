/*! legislature-tracker - v0.0.2 - 2013-05-01
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2013 ; Licensed MIT */

(function(e){_.mixin({trim:function(e){return e=String.prototype.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},cssClass:function(e){return e.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(e,t){var i,s,l,n,o="",a="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',c='<ins class="ellipsis-ellipsis">...</ins>',d='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==e.indexOf(a)?(i=e.indexOf(a),o+=r.replace("[[[TEXT]]]",e.substring(0,i))+" ",o+=c+" ",o+=d.replace("[[[TEXT]]]",e.substring(i,e.length))+" "):(n=e.split(" "),t>=n.length?o+=r.replace("[[[TEXT]]]",e):(s=n.slice(0,t),l=n.slice(t),o+=r.replace("[[[TEXT]]]",s.join(" "))+" ",o+=c+" ",o+=d.replace("[[[TEXT]]]",l.join(" "))+" ")),o}}),_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)}),e.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1}})(jQuery,window);var LT,originalLT,exports=exports||void 0;_.isUndefined(exports)?(originalLT=window.LT,LT={},LT.noConflict=function(){return window.LT=originalLT,this},window.LT=LT):LT=exports,function(e,t,i){LT.cache={},LT.cache.models={},LT.log=function(e){_.isUndefined(window.console)||window.console.log(e)},LT.utils={},LT.utils.getModel=function(e,t,i,s){var l=e+":"+t+":"+i[t];return s=s||LT.options,_.isUndefined(LT.cache.models[l])&&(LT.cache.models[l]=new LT[e](i,s)),LT.cache.models[l]},LT.utils.fetchModel=function(t){var i;return t.get("fetched")!==!0?t.fetch():(i=e.Deferred(),i.resolveWith(t),i)},LT.utils.translate=function(e,t){var i=t;return _.isObject(LT.options.wordTranslations[e])&&_.isString(LT.options.wordTranslations[e][t])&&(i=LT.options.wordTranslations[e][t]),i},LT.utils.imagePath=function(e){return 0===e.indexOf("http")?e:LT.imagePath+e},LT.templates=LT.templates||{},LT.utils.getTemplate=function(t,i,s,l){var n="js/app/templates/"+t+".html";_.isUndefined(LT.templates[n])?e.ajax({url:n,method:"GET",async:!1,contentType:"text",success:function(e){LT.templates[n]=_.template(e),i[s]=LT.templates[n],_.isFunction(l)&&l.apply(this,[e])}}):i[s]=LT.templates[n]},LT.parse=LT.parse||{},LT.parse.eData=function(e){var t={};t.categories=LT.parse.eCategories(e.sheets("Categories").all());var i=e.sheets("Bills").all();return i.length>LT.options.maxBills&&LT.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),t.bills=LT.parse.eBills(i.slice(0,LT.options.maxBills)),t.events=LT.parse.eEvents(e.sheets("Events").all()),_.each(_.groupBy(t.events,"bill_id"),function(e,i){_.each(t.bills,function(s,l){s.bill===i&&(t.bills[l].custom_events=e)})}),t},LT.parse.eBills=function(e){return _.map(e,function(e){return LT.parse.translateFields(LT.options.fieldTranslations.eBills,e),e.links=LT.parse.eLinks(e.links),e.categories=e.categories?e.categories.split(","):[],e.categories=_.map(e.categories,_.trim),e.bill?(e.hasBill=!0,e.bill_primary=e.bill?LT.utils.getModel("OSBillModel","bill_id",{bill_id:e.bill}):i,e.bill_companion=e.bill_companion?LT.utils.getModel("OSBillModel","bill_id",{bill_id:e.bill_companion}):i,e.bill_conference=e.bill_conference&&LT.options.conferenceBill?LT.utils.getModel("OSBillModel","bill_id",{bill_id:e.bill_conference}):i):(e.hasBill=!1,e.bill=e.title),e})},LT.parse.eCategories=function(e){return _.map(e,function(e){return LT.parse.translateFields(LT.options.fieldTranslations.eCategories,e),e.links=LT.parse.eLinks(e.links),e})},LT.parse.eEvents=function(e){return _.map(e,function(e){return LT.parse.translateFields(LT.options.fieldTranslations.eEvents,e),e.links=LT.parse.eLinks(e.links),e.date=moment(e.date),e.type=["custom"],e})},LT.parse.eLinks=function(e){var t=[];return e=_.trim(e),0===e.length?t:(e='"'===e.substring(0,1)?e.substring(1):e,e='"'===e.substring(e.length-1,e.length)?e.slice(0,-1):e,t=e.split('", "'),t=_.map(t,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}))},LT.parse.csvCategories=function(e){return e=_.trim(e),0===e.length?[]:(e='"'===e.substring(0,1)?e.substring(1):e,e='"'===e.substring(e.length-1,e.length)?e.slice(0,-1):e,e.split('", "'))},LT.parse.translateFields=function(e,t){_.each(e,function(e,i){t[i]=t[e],i!==e&&delete t[e]})},LT.defaultOptions={sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./css/images/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png"}}(jQuery,window),function(e,t,i){LT.OSModel=Backbone.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(LT.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(e,t){this.options=t,this.on("sync",function(e){e.set("fetched",!0)})}}),LT.OSStateModel=LT.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),LT.OSBillModel=LT.OSModel.extend({url:function(){return _.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){LT.OSBillModel.__super__.initialize.apply(this,arguments),this.on("sync",function(){this.parseOSData()})},parseOSData:function(){var e;this.set("created_at",moment(this.get("created_at"))),this.set("updated_at",moment(this.get("updated_at"))),e=this.get("action_dates"),_.each(e,function(t,i){e[i]=t?moment(t):t}),this.set("action_dates",e),e=this.get("actions"),_.each(e,function(t,i){e[i].date=t.date?moment(t.date):t.date}),this.set("actions",e),e=this.get("votes"),_.each(e,function(t,i){e[i].date=t.date?moment(t.date):t.date}),this.set("votes",e),e=this.get("custom_events"),_.isArray(e)&&e.length>0&&this.set("actions",_.union(this.get("actions"),e)),this.set("actions",_.sortBy(this.get("actions"),function(e,t){return-1*(e.date.unix()+t)})),this.set("newest_action",this.get("actions")[0])},getActionDate:function(e){return this.get("action_dates")[e]?this.get("action_dates")[e]:!1},isSubstituted:function(){var e=!1;return _.isBoolean(this.get("substitued"))?e=this.get("substitued"):LT.options.substituteMatch===!1?e=!1:(e=_.find(this.get("actions"),function(e){return e.action.match(LT.options.substituteMatch)}),e=e?!0:!1,this.set("substitued",e)),e}}),LT.OSLegislatorModel=LT.OSModel.extend({osType:"legislators"}),LT.OSCommitteeModel=LT.OSModel.extend({osType:"committees"}),LT.BillModel=Backbone.Model.extend({initialize:function(e,t){this.options=t,this.hasBill=e.hasBill},loadOSBills:function(t,i){var s=this,l=[];return _.each(["bill_primary","bill_companion","bill_conference"],function(e){s.get(e)&&l.push(LT.utils.fetchModel(s.get(e)))}),e.when.apply(e,l).done(function(){s.parseMeta(),t()}).fail(i),this},loadCategories:function(){this.get("categories")&&this.set("categories",_.map(this.get("categories"),function(e){return _.isObject(e)||(e=LT.utils.getModel("CategoryModel","id",{id:e})),e}))},lastUpdatedAt:function(){var e,t=this.get("bill_primary"),i=this.get("bill_companion"),s=this.get("bill_conference");return this.hasBill===!0&&(_.isUndefined(this.get("last_updated_at"))&&t.get("updated_at")?(e=t.get("updated_at"),i&&i.get("updated_at")&&(e=i.get("updated_at").unix()>e.unix()?i.get("updated_at"):e),s&&s.get("updated_at")&&(e=s.get("updated_at").unix()>e.unix()?s.get("updated_at"):e),this.set("last_updated_at",e)):_.isUndefined(this.get("last_updated_at"))&&!t.get("updated_at")&&LT.log("Could not fetch primary bill data from OpenStates. Check that the id "+this.get("bill_primary").get("bill_id")+" is formatted properly.")),this.get("last_updated_at")},newestAction:function(){var e,t=this.get("bill_primary"),i=this.get("bill_companion"),s=this.get("bill_conference");return this.hasBill===!0&&_.isUndefined(this.get("newest_action"))&&t.get("newest_action")&&(e=t.get("newest_action"),i&&i.get("newest_action")&&(e=i.get("newest_action").date.unix()>e.date.unix()?i.get("newest_action"):e),s&&s.get("newest_action")&&(e=s.get("newest_action").date.unix()>e.date.unix()?s.get("newest_action"):e),this.set("newest_action",e)),this.get("newest_action")},parseMeta:function(){var e={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},t={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(t.companion&&(this.get("bill_companion").isSubstituted()&&(t.substituted=!0),this.get("bill_primary").isSubstituted()&&(t.substituted=!0)),this.hasBill===!0&&(!t.companion||t.substituted)&&(e.lower=this.get("bill_primary").getActionDate("passed_lower"),e.upper=this.get("bill_primary").getActionDate("passed_upper")),t.companion&&!t.substituted&&this.hasBill===!0&&("upper"===this.get("bill_primary").get("chamber")?(e.upper=this.get("bill_primary").getActionDate("passed_upper"),e.lower=this.get("bill_companion").getActionDate("passed_lower")):(e.lower=this.get("bill_primary").getActionDate("passed_lower"),e.upper=this.get("bill_companion").getActionDate("passed_upper"))),t.conference&&this.hasBill===!0){var i=this.get("bill_conference").getActionDate("passed_lower"),s=this.get("bill_conference").getActionDate("passed_upper");i&&s&&(e.conference=i.unix()>=s.unix()?i:s)}this.hasBill===!0&&(e.signed=t.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed")),this.hasBill===!0&&(e.last=t.conference?this.get("bill_conference").getActionDate("last"):t.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last")),this.set("actions",e),this.set("bill_type",t),this.get("description")||this.set("description",this.get("bill_primary").get("summary")),this.get("custom_events")&&this.set("custom_events",_.sortBy(this.get("custom_events"),function(e,t){return-1*(e.date.unix()+t)}))}}),LT.CategoryModel=Backbone.Model.extend({initialize:function(e,t){this.options=t,this.set("bills",new LT.BillsCollection(null)),this.getBills()},getBills:function(){var e=this,t=LT.app.bills,i=this.get("id");return t.each(function(t){-1!==_.indexOf(t.get("categories"),i)&&e.get("bills").push(LT.utils.getModel("BillModel","bill",t.attributes))}),this},loadBills:function(t,s){var l=[],n=this;return this.get("bills").each(function(e){_.each(["bill_primary","bill_companion","bill_conference"],function(t){e.get(t)&&l.push(LT.utils.fetchModel(e.get(t)))})}),e.when.apply(e,l).done(function(){var l=[];n.get("bills").each(function(e){if(this.hasBill===!0&&!e.get("bill_companion")&&e.get("bill_primary").get("companions")){var t=e.get("bill_primary").get("companions")[0].bill_id.indexOf("SAME AS")>=0?e.get("bill_primary").get("companions")[0].bill_id.replace("SAME AS ",""):i;if(t){var s=LT.utils.getModel("OSBillModel","bill_id",{bill_id:t});e.set("bill_companion",s),l.push(LT.utils.fetchModel(e.get("bill_companion")))}}else e.parseMeta()}),l.length>0?e.when.apply(e,l).done(function(){n.get("bills").each(function(e){e.parseMeta()}),t()}).fail(s):t()}).fail(s),this}})}(jQuery,window),function(){LT.CategoriesCollection=Backbone.Collection.extend({model:LT.CategoryModel,comparator:function(e){return-1!==e.get("title").toLowerCase().indexOf("recent")?"zzzzz":e.get("title")}}),LT.BillsCollection=Backbone.Collection.extend({model:LT.BillModel,comparator:function(e){var t=e.newestAction()?-1*e.newestAction().date.unix():e.get("title");return t}}),LT.OSBillsCollection=Backbone.Collection.extend({model:LT.OSBillModel,comparator:function(e){var t=e.get("newest_action");return t&&(t=-1*t.date.unix()),t}})}(jQuery,window),function(e,t){LT.MainApplicationView=Backbone.View.extend({initialize:function(){this.$el.addClass("ls"),this.templates=this.templates||{},LT.utils.getTemplate("template-loading",this.templates,"loading"),LT.utils.getTemplate("template-error",this.templates,"error"),LT.utils.getTemplate("template-ebill",this.templates,"ebill"),LT.utils.getTemplate("template-osbill",this.templates,"osbill"),LT.utils.getTemplate("template-category",this.templates,"category"),LT.utils.getTemplate("template-categories",this.templates,"categories"),LT.utils.getTemplate("template-header",this.templates,"header"),_.bindAll(this)},events:{"click .bill-expand":"expandBill","click .expand-other-bills":"expandOtherBills"},loading:function(){return _.isNumber(LT.options.scrollOffset)&&(this.initialLoad===!0?this.resetScrollView():this.initialLoad=_.isUndefined(this.initialLoad)?!1:!0),this.$el.html(this.templates.loading({})),this},error:function(e){return this.$el.html(this.templates.error({error:e})),this},renderCategories:function(){this.$el.html(this.templates.categories({categories:LT.app.categories.toJSON(),options:LT.options}))},renderCategory:function(e){_.isObject(e)||(e=LT.app.categories.get(e)),e.get("bills").sort(),this.$el.html(this.templates.category({category:e.toJSON(),templates:this.templates,header:this.renderHeader()})),this.getLegislators().navigationGlue()},renderEBill:function(e){_.isObject(e)||(e=this.router.bills.get(e)),e.newestAction(),this.$el.html(this.templates.ebill({bill:e.toJSON(),expandable:!1,templates:this.templates,header:this.renderHeader()})),this.getLegislators().addTooltips().checkOverflows().navigationGlue()},renderOSBill:function(e){this.$el.html(this.templates.osbill({bill:e.toJSON(),detailed:!0,templates:this.templates,header:this.renderHeader()})),this.getLegislators().addTooltips().checkOverflows().navigationGlue()},renderHeader:function(){return this.templates.header({categories:LT.app.categories.toJSON()})},expandBill:function(t){t.preventDefault();var i=e(t.target),s=["More detail","Less detail"],l=i.text();return i.text(l===s[0]?s[1]:s[0]),i.parent().parent().toggleClass("expanded").find(".bill-bottom").slideToggle(),this.checkOverflows(),this},expandOtherBills:function(t){t.preventDefault();var i=e(t.target),s=["Show other bills","Hide other bills"],l=i.text();return i.text(l===s[0]?s[1]:s[0]),i.parent().find(".has-conference-bill").toggleClass("showing").slideToggle(),this.checkOverflows(),this},getLegislators:function(){return this.$el.find(".sponsor:not(.found)").each(function(){var t=e(this),i=t.data();if(i.id=i.legId,i.id){var s=LT.utils.getModel("OSLegislatorModel","id",i);e.when(LT.utils.fetchModel(s)).then(function(){new LT.LegislatorView({el:t,model:s}).render()})}}),this},addTooltips:function(){return this.$el.find(".bill-progress .bill-progress-section.completed").qtip({style:{classes:"qtip-shadow qtip-light"},position:{my:"bottom center",at:"top center"}}),this},checkOverflows:function(){return this.$el.find(".actions-inner, .co-sponsors-inner").each(function(){e(this).hasScrollBar()&&e(this).addClass("overflowed")}),this},resetScrollView:function(){return e("html, body").animate({scrollTop:this.$el.offset().top-LT.options.scrollOffset},1e3),this},navigationGlue:function(){var i=this.$el.offset().top,s=e(".ls-header");return e(".ls-header-container").height(s.outerHeight()),e(t).scroll(function(){var t=e(this);t.scrollTop()>i&&!s.hasClass("glued")?s.addClass("glued"):i>=t.scrollTop()&&s.hasClass("glued")&&s.removeClass("glued")}),this}}),LT.LegislatorView=Backbone.View.extend({model:LT.OSLegislatorModel,initialize:function(){this.templates=this.templates||{},LT.utils.getTemplate("template-legislator",this.templates,"legislator"),_.bindAll(this)},render:function(){return this.$el.addClass("found").html(this.templates.legislator(this.model.toJSON())),this}})}(jQuery,window),function(e){LT.Application=Backbone.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","bill-detail/:bill":"routeOSBill","*defaultR":"routeDefault"},initialize:function(e){LT.options=_.extend(LT.defaultOptions,e),LT.app=this,_.bindAll(this),this.mainView=new LT.MainApplicationView(LT.options),this.mainView.router=this,this.mainView.loading(),this.tabletop=Tabletop.init(_.extend(LT.options.tabletopOptions,{key:LT.options.eKey,callback:this.loadEBills,callbackContext:this,wanted:LT.options.sheetsWanted}))},loadEBills:function(t,i){var s=this,l=LT.parse.eData(i);this.categories=new LT.CategoriesCollection(null),this.bills=new LT.BillsCollection(null),_.each(l.bills,function(e){s.bills.add(LT.utils.getModel("BillModel","bill",e))}),_.each(l.categories,function(e){s.categories.add(LT.utils.getModel("CategoryModel","id",e))}),this.bills.each(function(e){e.loadCategories()}),LT.options.aggregateURL?e.jsonp({url:LT.options.aggregateURL,success:this.loadAggregateCounts}):this.start()},loadAggregateCounts:function(e){var t=this;_.each(e,function(e){"total-bills"===e.stat&&(t.totalBills=parseInt(e.value,10)),"total-bills-passed"===e.stat&&(t.totalBillsPassed=parseInt(e.value,10)),"total-bills-signed"===e.stat&&(t.totalBillsSigned=parseInt(e.value,10))}),this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0}),this.mainView.render()},routeCategories:function(){var e=this;this.mainView.loading(),this.getOSBasicBills(function(){e.makeRecentCategory(),e.mainView.renderCategories()},this.error)},routeCategory:function(e){var t=this;e=decodeURI(e),e=this.categories.get(e),this.mainView.loading(),e.loadBills(function(){t.mainView.renderCategory(e)},t.error)},routeRecentCategory:function(){var e=this;this.mainView.loading(),this.getOSBasicBills(function(){e.makeRecentCategory();var t=e.categories.get("recent");t.loadBills(function(){e.mainView.renderCategory(t)},e.error)},this.error)},routeEBill:function(e){var t=this,i=decodeURI(e);return(e=this.bills.where({bill:i})[0])?(this.mainView.loading(),e.loadOSBills(function(){t.mainView.renderEBill(e)},t.error),undefined):(this.navigate("/bill-detail/"+encodeURI(i),{trigger:!0,replace:!0}),undefined)},routeOSBill:function(t){var i=this;t=decodeURI(t),t=LT.utils.getModel("OSBillModel","bill_id",{bill_id:t}),this.mainView.loading(),e.when.apply(e,[LT.utils.fetchModel(t)]).done(function(){i.mainView.renderOSBill(t)}).fail(i.error)},makeRecentCategory:function(){if(!this.madeRecentCategory){var e={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+LT.options.recentChangeThreshold+" days.",image:LT.options.recentImage};this.bills.each(function(t){var i=t.get("categories"),s=t.get("hasBill");s===!0&&Math.abs(parseInt(t.lastUpdatedAt().diff(moment(),"days"),10))<LT.options.recentChangeThreshold&&(i.push(e.id),t.set("categories",i))}),this.categories.add(LT.utils.getModel("CategoryModel","id",e)),this.bills.each(function(e){e.loadCategories()}),this.madeRecentCategory=!0}},getOSBasicBills:function(t){var i=this,s=[];if(this.fetchedCategories)t.call(i);else{this.bills.each(function(e){_.each(["bill_primary","bill_companion","bill_conference"],function(t){e.get(t)&&s.push(e.get(t).get("bill_id"))})});var l="http://openstates.org/api/v1/bills/?state="+LT.options.state+"&search_window=session:"+LT.options.session+"&bill_id__in="+encodeURI(s.join("|"))+"&apikey="+LT.options.OSKey+"&callback=?";e.jsonp({url:l,success:function(e){i.fetchedCategories=!0,_.each(e,function(e){e.created_at=moment(e.created_at),e.updated_at=moment(e.updated_at),LT.utils.getModel("OSBillModel","bill_id",e).set(e)}),t.call(i)},error:this.error})}},error:function(e){this.mainView.error(e)}})}(jQuery,window);