/*! legislature-tracker - v0.0.1 - 2013-03-07
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2013 ; Licensed MIT */
(function(e,t,n){_.mixin({trim:function(e){return String.prototype.trim?e=e.trim():e=e.replace(/^\s+|\s+$/g,""),e},cssClass:function(e){return e.replace(/[^a-z0-9]/g,"-")}}),_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)})})(jQuery,window);var LT,originalLT,exports=exports||undefined;_.isUndefined(exports)?(originalLT=window.LT,LT={},LT.noConflict=function(){return window.LT=originalLT,this},window.LT=LT):LT=exports,function(e,t,n){LT.cache={},LT.cache.models={},LT.utils={},LT.utils.getModel=function(e,t,n,r){var i=e+":"+t+":"+n[t];return r=r||LT.options,_.isUndefined(LT.cache.models[i])&&(LT.cache.models[i]=new LT[e](n,r)),LT.cache.models[i]},LT.utils.fetchModel=function(t){var n;return t.get("fetched")!==!0?t.fetch():(n=e.Deferred(),n.resolveWith(t),n)},LT.utils.translate=function(e,t){var n=t;return _.isObject(LT.options.wordTranslations[e])&&_.isString(LT.options.wordTranslations[e][t])&&(n=LT.options.wordTranslations[e][t]),n},LT.templates=LT.templates||{},LT.utils.getTemplate=function(t,n,r,i){var s="js/app/templates/"+t+".html";_.isUndefined(LT.templates[s])?e.ajax({url:s,method:"GET",async:!1,contentType:"text",success:function(e){LT.templates[s]=_.template(e),n[r]=LT.templates[s],_.isFunction(i)&&i.apply(this,[e])}}):n[r]=LT.templates[s]},LT.parse=LT.parse||{},LT.parse.eData=function(e){var t={};return t.categories=LT.parse.eCategories(e.sheets("Categories").all()),t.bills=LT.parse.eBills(e.sheets("Bills").all()),t.events=LT.parse.eEvents(e.sheets("Events").all()),_.each(_.groupBy(t.events,"bill_id"),function(e,n){_.each(t.bills,function(r,i){r.bill_id===n&&(t.bills[i].custom_events=e)})}),t},LT.parse.eBills=function(e){return _.map(e,function(e){return LT.parse.translateFields(LT.options.fieldTranslations.eBills,e),e.links=LT.parse.eLinks(e.links),e.categories=e.categories?e.categories.split(","):[],e.categories=_.map(e.categories,_.trim),e.bill_primary=e.bill?LT.utils.getModel("OSBillModel","bill_id",{bill_id:e.bill}):n,e.bill_companion=e.bill_companion?LT.utils.getModel("OSBillModel","bill_id",{bill_id:e.bill_companion}):n,e.bill_conference=e.conference_bill?LT.utils.getModel("OSBillModel","bill_id",{bill_id:e.bill_conference}):n,e})},LT.parse.eCategories=function(e){return _.map(e,function(e){return LT.parse.translateFields(LT.options.fieldTranslations.eCategories,e),e.links=LT.parse.eLinks(e.links),e.open_states_subjects=LT.parse.csvCategories(e.open_states_subjects),e.legislator_subjects=LT.parse.csvCategories(e.legislator_subjects),e})},LT.parse.eEvents=function(e){return _.map(e,function(e){return LT.parse.translateFields(LT.options.fieldTranslations.eEvents,e),e.links=LT.parse.eLinks(e.links),e.date=moment(e.date),e.type=["custom"],e})},LT.parse.eLinks=function(e){var t=[];return e=_.trim(e),e.length===0?t:(e=e.substring(0,1)==='"'?e.substring(1):e,e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e,t=e.split('", "'),t=_.map(t,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}),t)},LT.parse.csvCategories=function(e){return e=_.trim(e),e.length===0?[]:(e=e.substring(0,1)==='"'?e.substring(1):e,e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e,e.split('", "'))},LT.parse.translateFields=function(e,t){_.each(e,function(e,n){t[n]=t[e],n!==e&&delete t[e]})},LT.defaultOptions={sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",open_states_subjects:"openstatessubjects",legislator_subjects:"legislatorsubjects"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}}}}(jQuery,window),this.LT=this.LT||{},this.LT.templates=this.LT.templates||{},this.LT.templates["js/app/templates/template-categories.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+='\n<div class="categories-container">\n  ',options.title&&(__p+="\n    <h2>"+options.title+"</h2>\n  "),__p+='\n\n  <ul class="category-list clear-block">\n    ';for(var c in categories)__p+='\n      <li class="category-item category-item-'+c+'">\n        <div class="category-inner category-'+_.cssClass(categories[c].id)+'">\n          <h3>\n            <a href="#/category/'+encodeURI(categories[c].id)+'">\n              '+categories[c].title+"\n            </a>\n          </h3>\n           \n          <div>\n            Watching \n            <strong>"+categories[c].bills.length+"</strong>\n            ",categories[c].total_bill_count&&(__p+="\n              of "+categories[c].total_bill_count+"\n            "),__p+="\n            bills.\n          </div>\n        </div>\n      </li>\n    ";__p+="\n  </ul>\n</div>"}return __p},this.LT.templates["js/app/templates/template-category.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+='\n<div class="ls-header">\n  <a href="#/">All Categories</a>\n</div>\n\n<div class="category-container">\n  <h2>'+category.title+"</h2>\n  \n  <p>"+category.description+"</p>\n  \n  ";if(_.isArray(category.links)&&category.links.length>0){__p+='\n    <ul class="e-links">\n      ';for(var l in category.links)__p+='\n        <li><a href="'+category.links[l].url+'">'+category.links[l].title+"</a></li>\n      ";__p+="\n    </ul>\n  "}__p+='\n  \n  <div class="clear-block bills-list">\n    ',category.bills.each(function(e){__p+="\n      "+templates.ebill({bill:e.toJSON(),expandable:!0,templates:templates})+"\n    "}),__p+='\n  </div>\n  \n  <div class="clear-block total-bill">\n    Watching \n    <strong>'+category.bills.length+"</strong>\n    ",typeof category.total_bill_count!="undefined"&&(__p+="\n      of "+category.total_bill_count+"\n    "),__p+="\n    bills in the "+category.title+" category.\n  </div>\n</div>"}return __p},this.LT.templates["js/app/templates/template-ebill.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+="",expandable||(__p+='\n  <div class="ls-header">\n    ',_.each(bill.categories,function(e,t){__p+='\n      <a href="#/category/'+e.get("id")+'">'+e.get("title")+"</a>",t<bill.categories.length-1&&(__p+=","),__p+="\n    "}),__p+="\n  </div>\n"),__p+='\n\n<div class="bill ebill ',expandable&&(__p+="is-expandable"),__p+='">\n  <div class="bill-top">\n    ',expandable?__p+="<h3>":__p+="<h2>",__p+="\n      "+bill.title+'\n      <a class="permalink" title="Permanent link to bill" href="#/bill/'+encodeURI(bill.bill)+'"></a>\n    ',expandable?__p+="</h3>":__p+="</h2>",__p+='\n    \n    <p class="description">'+bill.description+"</p>\n    \n    ";if(_.isArray(bill.links)&&bill.links.length>0){__p+='\n      <ul class="e-links">\n        ';for(var l in bill.links)__p+='\n          <li><a href="'+bill.links[l].url+'">'+bill.links[l].title+"</a></li>\n        ";__p+="\n      </ul>\n    "}__p+="\n    \n    ",expandable&&(__p+='\n      <a href="#" class="bill-expand">Expand</a>\n    '),__p+='\n  </div>\n  \n  <div class="bill-bottom">\n    <div class="clear-block">\n      ',_.isObject(bill.bill_primary)&&(__p+='\n        <div class="primary-bill">\n          '+templates.osbill({title:"Primary Bill",bill:bill.bill_primary.toJSON(),templates:templates})+"\n        </div>\n      "),__p+="\n      \n      ",_.isObject(bill.bill_companion)&&(__p+='\n        <div class="companion-bill">\n          '+templates.osbill({title:"Companion Bill",bill:bill.bill_companion.toJSON(),templates:templates})+"\n        </div>\n      "),__p+="\n    </div>\n  </div>\n</div>"}return __p},this.LT.templates["js/app/templates/template-error.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>';return __p},this.LT.templates["js/app/templates/template-legislator.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='\n<div class="legislator">\n  <img src="'+photo_url+'" />\n\n  <div class="legislator-info">\n    '+full_name+"<br />\n    District "+district+" ("+LT.utils.translate("partyAbbr",party)+") <br />\n    "+LT.utils.translate("chamber",chamber)+"\n  </div>\n</div>";return __p},this.LT.templates["js/app/templates/template-loading.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},this.LT.templates["js/app/templates/template-osbill.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+="",typeof detailed!="undefined"&&detailed&&(__p+='\n  <div class="ls-header">\n    <a href="#/">All Categories</a>\n  </div>\n'),__p+='\n\n<div class="osbill">\n  <h5>\n    ',typeof title!="undefined"?__p+="\n      "+title+" ("+bill.bill_id+")\n    ":__p+="\n      "+bill.bill_id+"\n    ",__p+='\n    <a class="permalink" title="Permanent link to bill" href="#/bill-detail/'+encodeURI(bill.bill_id)+'"></a>\n  </h5>\n  \n  ',typeof detailed!="undefined"&&detailed&&(__p+='\n    <p class="description">\n      '+bill.title+"\n    </p>\n  "),__p+='\n\n  <strong>Primary sponsors</strong>\n  <div class="sponsors primary-sponsors clear-block">\n    ';for(var a in bill.sponsors)__p+="\n      ",bill.sponsors[a].type==="primary"&&(__p+='\n        <div class="sponsor" data-leg-id="'+bill.sponsors[a].leg_id+'" data-sponsor-type="'+bill.sponsors[a].type+'">\n          '+bill.sponsors[a].name+" ("+bill.sponsors[a].type+")\n        </div>\n      "),__p+="\n    ";__p+='\n  </div>\n  \n  <strong>Actions</strong>\n  <div class="actions">\n    ';for(var a in bill.actions)__p+="\n      <div>\n        "+bill.actions[a].date.format("MMM DD, YYYY")+": "+bill.actions[a].action+"\n        ("+LT.utils.translate("chamber",bill.actions[a].actor)+")\n      </div>\n    ";__p+='\n  </div>\n\n  <strong>Co-Sponsors</strong>\n  <div class="sponsors co-sponsors clear-block">\n    ';for(var a in bill.sponsors)__p+="\n      ",bill.sponsors[a].type!=="primary"&&(__p+='\n        <div class="sponsor" data-leg-id="'+bill.sponsors[a].leg_id+'" data-sponsor-type="'+bill.sponsors[a].type+'">\n          '+bill.sponsors[a].name+" ("+bill.sponsors[a].type+")\n        </div>\n      "),__p+="\n    ";__p+='\n  </div>\n  \n  <strong>Full Text</strong>\n  <div class="sources">\n    ';for(var a in bill.sources)__p+='\n      <a href="'+bill.sources[a].url+'" target="_blank">Source</a> <br />\n    ';__p+="\n  </div>\n</div>"}return __p},function(e,t,n){LT.OSModel=Backbone.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(LT.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(e,t){this.options=t,this.on("sync",function(e,t){e.set("fetched",!0)})}}),LT.OSStateModel=LT.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),LT.OSBillModel=LT.OSModel.extend({url:function(){return _.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(e,t){LT.OSBillModel.__super__.initialize.apply(this,arguments),this.on("sync",function(e,t,n){this.parseOSData()})},parseOSData:function(){var e;this.set("created_at",moment(this.get("created_at"))),this.set("updated_at",moment(this.get("updated_at"))),e=this.get("action_dates"),_.each(e,function(t,n){e[n]=t?moment(t):t}),this.set("action_dates",e),e=this.get("actions"),_.each(e,function(t,n){e[n].date=t.date?moment(t.date):t.date}),this.set("actions",e),e=this.get("custom_events"),_.isArray(e)&&e.length>0&&this.set("actions",_.union(this.get("actions"),e)),this.set("actions",_.sortBy(this.get("actions"),function(e,t){return(e.date.unix()+t)*-1})),this.set("newest_action",this.get("actions")[0])}}),LT.OSLegislatorModel=LT.OSModel.extend({osType:"legislators"}),LT.OSCommitteeModel=LT.OSModel.extend({osType:"committees"}),LT.BillModel=Backbone.Model.extend({initialize:function(e,t){this.options=t},loadOSBills:function(t,n){var r=this,i=[];return _.each(["bill_primary","bill_companion","bill_conference"],function(e){r.get(e)&&i.push(LT.utils.fetchModel(r.get(e)))}),e.when.apply(e,i).done(t).fail(n),this},loadCategories:function(){this.get("categories")&&this.set("categories",_.map(this.get("categories"),function(e){return _.isObject(e)||(e=LT.utils.getModel("CategoryModel","id",{id:e})),e}))}}),LT.CategoryModel=Backbone.Model.extend({initialize:function(e,t){this.options=t,this.set("bills",new LT.BillsCollection(null)),this.getBills()},getBills:function(){var e=this,t=LT.app.bills,n=this.get("id");return t.each(function(t){_.indexOf(t.get("categories"),n)!==-1&&e.get("bills").push(LT.utils.getModel("BillModel","bill",t.attributes))}),this},loadBills:function(t,n){var r=[];return this.get("bills").each(function(e){_.each(["bill_primary","bill_companion","bill_conference"],function(t){e.get(t)&&r.push(LT.utils.fetchModel(e.get(t)))})}),e.when.apply(e,r).done(t).fail(n),this}})}(jQuery,window),function(e,t,n){LT.CategoriesCollection=Backbone.Collection.extend({model:LT.CategoryModel,comparator:function(e){return e.get("title")}}),LT.BillsCollection=Backbone.Collection.extend({model:LT.BillModel,comparator:function(e){return e.get("title")}}),LT.OSBillsCollection=Backbone.Collection.extend({model:LT.OSBillModel,comparator:function(e){var t=e.get("newest_action");return t&&(t=t.date.unix()*-1),t}})}(jQuery,window),function(e,t,n){LT.MainApplicationView=Backbone.View.extend({initialize:function(e){this.$el.addClass("ls"),this.templates=this.templates||{},LT.utils.getTemplate("template-loading",this.templates,"loading"),LT.utils.getTemplate("template-error",this.templates,"error"),LT.utils.getTemplate("template-ebill",this.templates,"ebill"),LT.utils.getTemplate("template-osbill",this.templates,"osbill"),LT.utils.getTemplate("template-category",this.templates,"category"),LT.utils.getTemplate("template-categories",this.templates,"categories"),_.bindAll(this)},events:{"click .bill-expand":"expandBill"},loading:function(){this.$el.html(this.templates.loading({}))},error:function(e){this.$el.html(this.templates.error({error:e}))},renderCategories:function(){this.$el.html(this.templates.categories({categories:LT.app.categories.toJSON(),options:LT.options}))},renderCategory:function(e){var t=this,n;_.isObject(e)||(e=LT.app.categories.get(e)),this.$el.html(this.templates.category({category:e.toJSON(),templates:this.templates})),this.getLegislators()},renderEBill:function(e){_.isObject(e)||(e=this.router.bills.get(e)),this.$el.html(this.templates.ebill({bill:e.toJSON(),expandable:!1,templates:this.templates})),this.getLegislators(),this.addTooltips()},renderOSBill:function(e){this.$el.html(this.templates.osbill({bill:e.toJSON(),detailed:!0,templates:this.templates})),this.getLegislators(),this.addTooltips()},expandBill:function(t){t.preventDefault();var n=e(t.target);n.parent().parent().toggleClass("expanded").find(".bill-bottom").slideToggle()},getLegislators:function(){this.$el.find(".sponsor:not(.found)").each(function(){var t=e(this),n=t.data();n.id=n.legId;if(n.id){var r=LT.utils.getModel("OSLegislatorModel","id",n);e.when(LT.utils.fetchModel(r)).then(function(){var e=(new LT.LegislatorView({el:t,model:r})).render()})}})},addTooltips:function(){this.$el.find(".bill-progress .bill-progress-section.completed").qtip({style:{classes:"qtip-shadow qtip-light"},position:{my:"bottom center",at:"top center"}})}}),LT.LegislatorView=Backbone.View.extend({model:LT.OSLegislatorModel,initialize:function(e){this.templates=this.templates||{},LT.utils.getTemplate("template-legislator",this.templates,"legislator"),_.bindAll(this)},render:function(){return this.$el.addClass("found").html(this.templates.legislator(this.model.toJSON())),this}})}(jQuery,window),function(e,t,n){LT.Application=Backbone.Router.extend({routes:{categories:"routeCategories","category/:category":"routeCategory","bill/:bill":"routeEBill","bill-detail/:bill":"routeOSBill","*defaultR":"routeDefault"},initialize:function(e){LT.options=_.extend(LT.defaultOptions,e),LT.app=this,_.bindAll(this),this.mainView=new LT.MainApplicationView(LT.options),this.mainView.router=this,this.mainView.loading(),this.tabletop=Tabletop.init({key:LT.options.eKey,callback:this.loadEBills,callbackContext:this,wanted:LT.options.sheetsWanted})},loadEBills:function(t,n){var r=this,i=LT.parse.eData(n);this.categories=new LT.CategoriesCollection(null),this.bills=new LT.BillsCollection(null),_.each(i.bills,function(e){r.bills.add(LT.utils.getModel("BillModel","bill",e))}),_.each(i.categories,function(e){r.categories.add(LT.utils.getModel("CategoryModel","id",e))}),this.bills.each(function(e){e.loadCategories()}),LT.options.billCountDataSource?e.jsonp({url:this.options.billCountDataSource,success:this.loadBillCounts}):this.start()},loadBillCounts:function(e){this.categories.each(function(t){var n=t.get("legislator_subjects"),r=0;_.isArray(n)&&n.length>0&&(_.each(n,function(t){var n=_.find(e,function(e){return e.topic===t});r+=n.bill_count}),t.set("total_bill_count",r))}),this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0}),this.mainView.render()},routeCategories:function(){this.mainView.loading(),this.getOSBasicBills(this.mainView.renderCategories,this.error)},routeCategory:function(e){var t=this;e=decodeURI(e),e=this.categories.get(e),this.mainView.loading(),e.loadBills(function(){t.mainView.renderCategory(e)},t.error)},routeEBill:function(e){var t=this;e=decodeURI(e),e=this.bills.where({bill:e})[0],this.mainView.loading(),e.loadOSBills(function(){t.mainView.renderEBill(e)},t.error)},routeOSBill:function(t){var n=this;t=decodeURI(t),t=LT.utils.getModel("OSBillModel","bill_id",{bill_id:t}),this.mainView.loading(),e.when.apply(e,[LT.utils.fetchModel(t)]).done(function(){n.mainView.renderOSBill(t)}).fail(n.error)},getOSBasicBills:function(t,n){var r=this,i=[];if(!this.fetchedCategories){this.bills.each(function(e){_.each(["bill_primary","bill_companion","bill_conference"],function(t){e.get(t)&&i.push(e.get(t).get("bill_id"))})});var s="http://openstates.org/api/v1/bills/?state="+LT.options.state+"&search_window=session:"+LT.options.session+"&bill_id__in="+encodeURI(i.join("|"))+"&apikey="+LT.options.OSKey+"&callback=?";e.jsonp({url:s,success:function(e){r.fetchedCategories=!0,_.each(e,function(e){e.created_at=moment(e.created_at),e.updated_at=moment(e.updated_at),LT.utils.getModel("OSBillModel","bill_id",e).set(e)}),t.call(r)},error:this.error})}else t.call(r)},error:function(e){this.mainView.error(e)}})}(jQuery,window);