/*! legislature-tracker - v0.0.1 - 2013-02-20
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2013 ; Licensed MIT */
(function(e,t,n){_.mixin({trim:function(e){return String.prototype.trim?e=e.trim():e=e.replace(/^\s+|\s+$/g,""),e}}),_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)})})(jQuery,window);var LT,originalLT,exports=exports||undefined;_.isUndefined(exports)?(originalLT=window.LT,LT={},LT.noConflict=function(){return window.LT=originalLT,this},window.LT=LT):LT=exports,function(e,t,n){LT.cache={},LT.cache.models={},LT.utils={},LT.utils.getModel=function(e,t,n,r){var i=e+":"+t+":"+n[t];return r=r||LT.options,_.isUndefined(LT.cache.models[i])&&(LT.cache.models[i]=new LT[e](n,r)),LT.cache.models[i]},LT.utils.fetchModel=function(t){var n;return t.get("fetched")!==!0?t.fetch():(n=e.Deferred(),n.resolve(t),n)},LT.utils.translate=function(e,t){var n=t;return _.isObject(LT.options.wordingTranslations[e])&&_.isString(LT.options.wordingTranslations[e][t])&&(n=LT.options.wordingTranslations[e][t]),n},LT.templates=LT.templates||{},LT.utils.getTemplate=function(t,n,r,i){var s="js/app/templates/"+t+".html";_.isUndefined(LT.templates[s])?e.ajax({url:s,method:"GET",async:!1,contentType:"text",success:function(e){LT.templates[s]=_.template(e),n[r]=LT.templates[s],_.isFunction(i)&&i.apply(this,[e])}}):n[r]=LT.templates[s]},LT.parse=LT.parse||{},LT.parse.eData=function(e){var t={};return t.categories=LT.parse.eCategories(e.sheets("Categories").all()),t.bills=LT.parse.eBills(e.sheets("Bills").all()),t.events=LT.parse.eEvents(e.sheets("Events").all()),_.each(_.groupBy(t.events,"bill_id"),function(e,n){_.each(t.bills,function(r,i){r.bill_id===n&&(t.bills[i].custom_events=e)})}),t},LT.parse.eBills=function(e){return _.map(e,function(e){return _.each(LT.options.fieldTranslations.eBills,function(t,n){e[n]=e[t],delete e[t]}),e.ecategories=e.ecategories.split(","),e.ecategories=_.map(e.ecategories,_.trim),e.links=LT.parse.eLinks(e.links),e})},LT.parse.eCategories=function(e){return _.map(e,function(e){return _.each(LT.options.fieldTranslations.eCategories,function(t,n){e[n]=e[t],delete e[t]}),e.links=LT.parse.eLinks(e.links),e.open_states_subjects=LT.parse.csvCategories(e.open_states_subjects),e.legislator_subjects=LT.parse.csvCategories(e.legislator_subjects),e})},LT.parse.eEvents=function(e){return _.map(e,function(e){return _.each(LT.options.fieldTranslations.eEvents,function(t,n){e[n]=e[t],delete e[t]}),e.links=LT.parse.eLinks(e.links),e.date=moment(e.date),e.type=["custom"],e})},LT.parse.eLinks=function(e){var t=[];return e=_.trim(e),e.length===0?t:(e=e.substring(0,1)==='"'?e.substring(1):e,e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e,t=e.split('", "'),t=_.map(t,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}),t)},LT.parse.csvCategories=function(e,t){return e=_.trim(e),e.length===0?[]:(e=e.substring(0,1)==='"'?e.substring(1):e,e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e,e.split('", "'))},LT.defaultOptions={title:"Legislature Tracker",eBillsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",open_states_subjects:"openstatessubjects",legislator_subjects:"legislatorsubjects"},eBills:{bill_id:"bill",ecategories:"categories",etitle:"title",edescription:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordingTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}}}}(jQuery,window),this.LT=this.LT||{},this.LT.templates=this.LT.templates||{},this.LT.templates["js/app/templates/template-bill-progress.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='\n<div class="bill-progress clear-block">\n  <div class="bill-progress-section bill-introduced ',action_dates.introduced&&(__p+="completed"),__p+='"\n    title="Bill introduced',action_dates.introduced&&(__p+=" on "+action_dates.introduced.format("MMM DD")+""),__p+='">\n  </div>\n  \n  <div class="bill-progress-section bill-passed-lower ',action_dates.passed_lower&&(__p+="completed"),__p+='"\n    title="Bill passed House',action_dates.passed_lower&&(__p+=" on "+action_dates.passed_lower.format("MMM DD")+""),__p+='">\n  </div>\n  \n  <div class="bill-progress-section bill-passed-upper ',action_dates.passed_upper&&(__p+="completed"),__p+='"\n    title="Bill passed Senate',action_dates.passed_upper&&(__p+=" on "+action_dates.passed_upper.format("MMM DD")+""),__p+='">\n  </div>\n  \n  <div class="bill-progress-section bill-signed ',action_dates.signed&&(__p+="completed"),__p+='"\n    title="Bill signed',action_dates.signed&&(__p+=" on "+action_dates.signed.format("MMM DD")+""),__p+='">\n  </div>\n</div>';return __p},this.LT.templates["js/app/templates/template-bill.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+="";if(!expandable&&_.isArray(bill.ecategories)&&bill.ecategories.length>0){__p+="\n  ";for(var c in bill.ecategories)__p+='\n    <a href="#/category/'+encodeURI(bill.ecategories[c])+'">'+bill.ecategories[c]+"</a>\n  ";__p+="\n"}__p+='\n\n<div class="bill ',expandable&&(__p+="is-expandable"),__p+='">\n  <div class="bill-top">\n    ',expandable?__p+="<h3>":__p+="<h2>",__p+="\n      ",bill.etitle?__p+="\n        "+bill.etitle+"\n      ":__p+="\n        "+bill.title+"\n      ",__p+="\n        \n      ("+bill.bill_id+') \n      <a class="permalink" title="Permanent link to bill" href="#/bill/'+encodeURI(bill.bill_id)+'"></a>\n    ',expandable?__p+="</h3>":__p+="</h2>",__p+="\n    \n    "+progress+'\n    \n    <div class="bill-updated">\n      Last updated '+bill.newest_action.date.diff(moment(),"days")*-1+' day(s) ago\n    </div>\n    \n    <p class="description">'+bill.edescription+"</p>\n    \n    ",expandable&&(__p+='\n      <a href="#" class="bill-expand">Expand</a>\n    '),__p+='\n  </div>\n  \n  <div class="bill-bottom">\n    <strong>Sponsors</strong>\n    <div class="sponsors clear-block">\n      ';for(var a in bill.sponsors)__p+='\n        <div class="sponsor" data-leg-id="'+bill.sponsors[a].leg_id+'" data-sponsor-type="'+bill.sponsors[a].type+'">\n          '+bill.sponsors[a].name+" ("+bill.sponsors[a].type+")\n        </div>\n      ";__p+='\n    </div>\n    \n    <strong>Actions</strong>\n    <div class="actions">\n      ';for(var a in bill.actions)__p+="\n        <div>\n          "+bill.actions[a].date.format("MMM DD, YYYY")+": "+bill.actions[a].action+"\n          ("+LT.utils.translate("chamber",bill.actions[a].actor)+")\n        </div>\n      ";__p+='\n    </div>\n    \n    <strong>Sources</strong>\n    <div class="sources">\n      ';for(var a in bill.sources)__p+='\n        <a href="'+bill.sources[a].url+'">'+bill.sources[a].url+"</a> <br />\n      ";__p+="\n    </div>\n  </div>\n</div>"}return __p},this.LT.templates["js/app/templates/template-categories.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+='\n<div class="categories-container">\n  ',options.title&&(__p+="\n    <h2>"+options.title+"</h2>\n  "),__p+='\n\n  <ul class="clear-block">\n    ';for(var c in categories)__p+='\n      <li>\n        <div class="category-inner">\n          <h3>\n            <a href="#/category/'+encodeURI(categories[c].id)+'">\n              '+categories[c].title+"\n            </a>\n          </h3>\n          \n          <p>"+categories[c].description+"</p>\n           \n          <div>\n            Watching \n            <strong>"+categories[c].bills.length+"</strong>\n            ",categories[c].total_bill_count&&(__p+="\n              of "+categories[c].total_bill_count+"\n            "),__p+="\n            bills.\n          </div>\n        </div>\n      </li>\n    ";__p+="\n  </ul>\n</div>"}return __p},this.LT.templates["js/app/templates/template-category.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+='\n<a href="#/">All Categories</a>\n\n<div class="category-container">\n  <h2>'+title+"</h2>\n  \n  <p>"+description+"</p>\n  \n  ";if(_.isArray(links)&&links.length>0){__p+='\n    <ul class="e-links">\n      ';for(var l in links)__p+='\n        <li><a href="'+links[l].url+'">'+links[l].title+"</a></li>\n      ";__p+="\n    </ul>\n  "}__p+='\n  \n  <div class="clear-block bills-list">\n    ';for(var b in bills)__p+="\n      "+bills[b]+"\n    ";__p+='\n  </div>\n  \n  <div class="clear-block total-bill">\n    Watching \n    <strong>'+bills.length+"</strong>\n    ",typeof total_bill_count!="undefined"&&(__p+="\n      of "+total_bill_count+"\n    "),__p+="\n    bills in the "+title+" category.\n  </div>\n</div>"}return __p},this.LT.templates["js/app/templates/template-legislator.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='\n<div class="legislator">\n  <img src="'+photo_url+'" />\n\n  <div class="legislator-info">\n    '+full_name+" ("+sponsorType+")<br />\n    District "+district+" ("+LT.utils.translate("partyAbbr",party)+") <br />\n    "+LT.utils.translate("chamber",chamber)+"\n  </div>\n</div>";return __p},this.LT.templates["js/app/templates/template-loading.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},function(e,t,n){LT.OSModel=Backbone.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(this.options.apiKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(e,t){this.options=t,this.on("sync",function(e,t,n){e.set("fetched",!0)})},parseOSData:function(){this.set("created_at",moment(this.get("created_at"))),this.set("updated_at",moment(this.get("updated_at"))),this.set("newest_action",this.get("actions")[0])}}),LT.OSStateModel=LT.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),LT.OSBillModel=LT.OSModel.extend({url:function(){return _.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(e,t){LT.OSBillModel.__super__.initialize.apply(this,arguments),this.on("sync",function(e,t,n){this.parseOSData()})},parseOSData:function(){var e;this.set("created_at",moment(this.get("created_at"))),this.set("updated_at",moment(this.get("updated_at"))),e=this.get("action_dates"),_.each(e,function(t,n){e[n]=t?moment(t):t}),this.set("action_dates",e),e=this.get("actions"),_.each(e,function(t,n){e[n].date=t.date?moment(t.date):t.date}),this.set("actions",e),this.set("newest_action",this.get("actions")[0]),e=this.get("action_dates"),_.each(this.get("actions"),function(t){t.type.indexOf("bill:introduced")!==-1&&(e.introduced=t.date)}),this.set("action_dates",e),e=this.get("custom_events"),_.isArray(e)&&e.length>0&&this.set("actions",_.union(this.get("actions"),e)),this.set("actions",_.sortBy(this.get("actions"),function(e){return e.date.unix()}))}}),LT.OSLegislatorModel=LT.OSModel.extend({osType:"legislators"}),LT.OSCommitteeModel=LT.OSModel.extend({osType:"committees"}),LT.CategoryModel=Backbone.Model.extend({initialize:function(e,t){this.options=t,this.set("bills",new LT.BillsCollection(null,this.options)),this.getBills()},getBills:function(){var e=this,t=this.options.app.bills,n=this.get("id");t.each(function(t){_.indexOf(t.get("ecategories"),n)!==-1&&e.get("bills").push(LT.utils.getModel("OSBillModel","bill_id",t.attributes,e.options))})}})}(jQuery,window),function(e,t,n){LT.CategoriesCollection=Backbone.Collection.extend({model:LT.CategoryModel}),LT.BillsCollection=Backbone.Collection.extend({model:LT.OSBillModel,comparator:"updated_at"})}(jQuery,window),function(e,t,n){LT.MainApplicationView=Backbone.View.extend({initialize:function(e){this.$el.addClass("ls"),this.templates=this.templates||{},LT.utils.getTemplate("template-loading",this.templates,"loading"),LT.utils.getTemplate("template-bill",this.templates,"bill"),LT.utils.getTemplate("template-category",this.templates,"category"),LT.utils.getTemplate("template-categories",this.templates,"categories"),LT.utils.getTemplate("template-bill-progress",this.templates,"billProgress"),_.bindAll(this)},events:{"click .bill-expand":"expandBill"},loading:function(){this.$el.html(this.templates.loading({}))},renderCategories:function(){this.$el.html(this.templates.categories({categories:this.router.categories.toJSON(),bills:this.router.bills.toJSON(),options:this.options}))},renderCategory:function(e){var t=this,n;_.isObject(e)||(e=this.router.categories.get(e)),n=e.toJSON(),n.bills=n.bills.map(function(e){var n=e.toJSON();return t.templates.bill({bill:n,expandable:!0,progress:t.templates.billProgress(n)})}),this.$el.html(this.templates.category(n)),this.getLegislators()},renderBill:function(e){_.isObject(e)||(e=this.router.bills.get(e));var t=e.toJSON();this.$el.html(this.templates.bill({bill:t,expandable:!1,progress:this.templates.billProgress(t)})),this.getLegislators()},expandBill:function(t){t.preventDefault();var n=e(t.target);n.parent().parent().toggleClass("expanded").find(".bill-bottom").slideToggle()},getLegislators:function(){this.$el.find(".sponsor:not(.found)").each(function(){var t=e(this),n=t.data();n.id=n.legId;if(n.id){var r=LT.utils.getModel("OSLegislatorModel","id",n);e.when(LT.utils.fetchModel(r)).then(function(){var e=(new LT.LegislatorView({el:t,model:r})).render()})}})}}),LT.LegislatorView=Backbone.View.extend({model:LT.OSLegislatorModel,initialize:function(e){this.templates=this.templates||{},LT.utils.getTemplate("template-legislator",this.templates,"legislator"),_.bindAll(this)},render:function(){return this.$el.addClass("found").html(this.templates.legislator(this.model.toJSON())),this}})}(jQuery,window),function(e,t,n){LT.Application=Backbone.Router.extend({routes:{categories:"categories","category/:category":"category","bill/:bill":"bill","*defaultR":"defaultR"},initialize:function(e){e=LT.options=_.extend(LT.defaultOptions,e),this.options=e,this.options.app=this,_.bindAll(this),this.mainView=new LT.MainApplicationView(e),this.mainView.router=this,this.mainView.loading(),this.tabletop=Tabletop.init({key:this.options.dataKey,callback:this.loadEBills,callbackContext:this,wanted:this.options.eBillsWanted})},loadEBills:function(t,n){var r=this,i=LT.parse.eData(n,this.options);this.categories=new LT.CategoriesCollection(null,this.options),this.bills=new LT.BillsCollection(null,this.options),_.each(i.bills,function(e){r.bills.push(LT.utils.getModel("OSBillModel","bill_id",e,r.options))}),_.each(i.categories,function(e){r.categories.push(LT.utils.getModel("CategoryModel","id",e,r.options))}),this.options.billCountDataSource?e.jsonp({url:this.options.billCountDataSource,success:this.loadBillCounts}):this.start()},loadBillCounts:function(e){this.categories.each(function(t){var n=t.get("legislator_subjects"),r=0;_.isArray(n)&&n.length>0&&(_.each(n,function(t){var n=_.find(e,function(e){return e.topic===t});r+=n.bill_count}),t.set("total_bill_count",r))}),this.start()},start:function(){Backbone.history.start()},defaultR:function(){this.navigate("/categories",{trigger:!0,replace:!0}),this.mainView.render()},categories:function(){this.mainView.renderCategories()},category:function(t){var n=this;t=decodeURI(t),t=this.categories.get(t),this.mainView.loading();var r=t.get("bills"),i=[];r.each(function(e){i.push(LT.utils.fetchModel(e))}),e.when.apply(null,i).then(function(){n.mainView.renderCategory(t)},this.error)},bill:function(t){var n=this;t=decodeURI(t),t=this.bills.where({bill_id:t})[0],this.mainView.loading(),e.when(LT.utils.fetchModel(t)).then(function(){n.mainView.renderBill(t)},this.error)},error:function(e){}})}(jQuery,window);