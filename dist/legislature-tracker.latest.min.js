/*! legislature-tracker - v0.0.1 - 2013-02-13
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2013 ; Licensed MIT */
(function(e,t,n){_.mixin({trim:function(e){return String.prototype.trim?e=e.trim():e=e.replace(/^\s+|\s+$/g,""),e}}),_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)})})(jQuery,window);var LT,originalLT,exports=exports||undefined;_.isUndefined(exports)?(originalLT=window.LT,LT={},LT.noConflict=function(){return window.LT=originalLT,this},window.LT=LT):LT=exports,function(e,t,n){LT.cache={},LT.cache.models={},LT.utils={},LT.utils.getModel=function(e,t,n,r){var i=e+":"+t+":"+n[t];return _.isUndefined(LT.cache.models[i])&&(LT.cache.models[i]=new LT[e](n,r)),LT.cache.models[i]},LT.utils.fetchModel=function(e,t){e.get("fetched")!==!0?e.fetch(t):t.success.apply(e,[e,!1,!1])},LT.templates=LT.templates||{},LT.utils.getTemplate=function(t,n,r,i){var s="js/app/templates/"+t+".html";_.isUndefined(LT.templates[s])?e.ajax({url:s,method:"GET",async:!1,contentType:"text",success:function(e){LT.templates[s]=_.template(e),n[r]=LT.templates[s],_.isFunction(i)&&i.apply(this,[e])}}):n[r]=LT.templates[s]},LT.parse=LT.parse||{},LT.parse.eData=function(e,t){var n={};return n.categories=LT.parse.eCategories(e.sheets("Categories").all(),t),n.bills=LT.parse.eBills(e.sheets("Bills").all(),t),n.events=LT.parse.eEvents(e.sheets("Events").all(),t),n},LT.parse.eBills=function(e,t){return _.map(e,function(e){return _.each(t.translations.eBills,function(t,n){e[n]=e[t]}),e.ecategories=e.ecategories.split(","),e.ecategories=_.map(e.ecategories,_.trim),e.links=LT.parse.eLinks(e.links),e})},LT.parse.eCategories=function(e,t){return _.map(e,function(e){return _.each(t.translations.eCategories,function(t,n){e[n]=e[t]}),e.links=LT.parse.eLinks(e.links),e.open_states_subjects=LT.parse.osCategories(e.open_states_subjects),e})},LT.parse.eEvents=function(e,t){return _.map(e,function(e){return _.each(t.translations.eEvents,function(t,n){e[n]=e[t]}),e.links=LT.parse.eLinks(e.links),e.date=moment(e.date),e})},LT.parse.eLinks=function(e,t){var n=[];return e=_.trim(e),e.length===0?n:(e=e.substring(0,1)==='"'?e.substring(1):e,e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e,n=e.split('", "'),n=_.map(n,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}),n)},LT.parse.osCategories=function(e,t){return e=_.trim(e),e.length===0?[]:(e=e.substring(0,1)==='"'?e.substring(1):e,e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e,e.split('", "'))},LT.defaultOptions={title:"Legislature Tracker",eBillsWanted:["Categories","Bills","Events"],translations:{eCategories:{category_id:"categoryid",open_states_subjects:"openstatessubjects"},eBills:{bill_id:"bill",ecategories:"categories",etitle:"title",edescription:"description"},eEvents:{bill_id:"bill"}}}}(jQuery,window),this.LT=this.LT||{},this.LT.templates=this.LT.templates||{},this.LT.templates["js/app/templates/template-bill.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='\n<div class="bill-container">\n  <h4>'+bill_id+"</h4>\n  <h5>"+etitle+"</h5>\n  <p>"+edescription+"</p>\n</div>";return __p},this.LT.templates["js/app/templates/template-categories.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+='\n<div class="categories-container">\n  <h1>'+options.title+"</h1>\n\n  <ul>\n    ";for(var c in categories)__p+='\n      <li><a href="#/category/'+encodeURI(categories[c].name)+'">'+categories[c].name+"</li>\n    ";__p+="\n  </ul>\n</div>"}return __p},this.LT.templates["js/app/templates/template-category.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{}){__p+='\n<div class="category-container">\n  <h4>'+name+"</h4>\n  <ul>\n    ";for(var b in bills)__p+='\n      <li><a href="#/bill/'+encodeURI(bills[b])+'">'+bills[b]+"</li>\n    ";__p+="\n  </ul>\n</div>"}return __p},this.LT.templates["js/app/templates/template-loading.html"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},function(e,t,n){LT.OSModel=Backbone.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(this.options.apiKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(e,t){this.options=t,this.on("sync",function(e,t,n){e.set("fetched",!0)})}}),LT.OSStateModel=LT.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),LT.OSBillModel=LT.OSModel.extend({url:function(){return _.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()}}),LT.OSLegislatorModel=LT.OSModel.extend({osType:"legislators"}),LT.OSCommitteeModel=LT.OSModel.extend({osType:"committees"}),LT.CategoryModel=Backbone.Model.extend({initialize:function(e,t){this.options=t},bills:function(){var e=this,t=[];return _.each(this.get("bills"),function(n){t.push(LT.utils.getModel("OSBillModel","bill_id",n,e.options))}),t}})}(jQuery,window),function(e,t,n){LT.CategoriesCollection=Backbone.Collection.extend({model:LT.CategoryModel}),LT.BillsCollection=Backbone.Collection.extend({model:LT.OSBillModel})}(jQuery,window),function(e,t,n){LT.MainApplicationView=Backbone.View.extend({initialize:function(e){this.$el.addClass("ls"),this.templates=this.templates||{},LT.utils.getTemplate("template-loading",this.templates,"loading"),LT.utils.getTemplate("template-bill",this.templates,"bill"),LT.utils.getTemplate("template-category",this.templates,"category"),LT.utils.getTemplate("template-categories",this.templates,"categories")},loading:function(){this.$el.html(this.templates.loading({}))},renderCategories:function(){this.$el.html(this.templates.categories({categories:this.router.categories.toJSON(),bills:this.router.bills.toJSON(),options:this.options}))},renderCategory:function(e){_.isObject(e)||(e=this.router.categories.get(e)),this.$el.html(this.templates.category(e.toJSON()))},renderBill:function(e){_.isObject(e)||(e=this.router.bills.get(e)),this.$el.html(this.templates.bill(e.toJSON()))}})}(jQuery,window),LT.Application=Backbone.Router.extend({routes:{categories:"categories","category/:category":"category","bill/:bill":"bill","*defaultR":"defaultR"},initialize:function(e){e=_.extend(LT.defaultOptions,e),this.options=e,this.options.app=this,_.bindAll(this),this.mainView=new LT.MainApplicationView(e),this.mainView.router=this,this.mainView.loading(),this.tabletop=Tabletop.init({key:this.options.dataKey,callback:this.loadEBills,callbackContext:this,wanted:this.options.eBillsWanted})},loadEBills:function(e,t){var n=this,r=LT.parse.eData(t,this.options);e=r.bills,this.categories=new LT.CategoriesCollection(null,this.options),this.bills=new LT.BillsCollection(null,this.options),_.each(e,function(e){_.each(e.ecategories,function(t){var r,i=LT.utils.getModel("CategoryModel","id",{id:t},n.options);i.set("name",t),r=i.get("bills"),_.isUndefined(r)?i.set("bills",[e.bill_id]):(r.push(e.bill_id),i.set("bills",r)),n.categories.push(i)})}),_.each(e,function(e){n.bills.push(LT.utils.getModel("OSBillModel","bill_id",e,n.options))}),this.start()},start:function(){Backbone.history.start()},defaultR:function(){this.navigate("/categories",{trigger:!0,replace:!0}),this.mainView.render()},categories:function(){this.mainView.renderCategories()},category:function(e){e=decodeURI(e),this.mainView.renderCategory(e)},bill:function(e){var t=this;e=decodeURI(e);var n=LT.utils.getModel("OSBillModel","bill_id",{bill_id:e},this.options);LT.utils.fetchModel(n,{success:function(e,n,r){t.mainView.renderBill(e)},error:this.error})},error:function(e){}});